# Test_6.ipynb 実施内容解説
## 時系列最適化ResNet + Self-Attention音楽分類モデル

### 概要
test_6.ipynbでは、音楽の時系列特性に特化した最先端のハイブリッドアーキテクチャを実装しました。ResNet（残差ネットワーク）とSelf-Attention機構を組み合わせ、音楽の長距離依存関係と時間的構造を効率的に捉える音楽ジャンル分類モデルを構築しています。

---

## 1. アーキテクチャの特徴

### 1.1 ハイブリッド設計
- **ResNet残差ブロック**: 深層学習における勾配消失問題を解決
- **Self-Attention機構**: 音楽の長距離依存関係（例：イントロ-サビの関係）を捉える
- **時系列最適化**: 音楽の時間軸を重視したカーネル設計（3×5カーネル）

### 1.2 6段階特徴抽出パイプライン
1. **初期特徴抽出**: 時間軸保持畳み込み（7×11カーネル）
2. **残差ブロック群**: 3段階の詳細〜高レベル特徴抽出
3. **2D→1D変換**: 周波数次元統合で時系列フォーカス
4. **Self-Attention層群**: 3層のマルチヘッド自己注意機構
5. **テンポラルアテンションプーリング**: 時系列情報の重み付き集約
6. **最終分類層**: 6層の全結合層による分類

---

## 2. データ処理・特徴量抽出

### 2.1 時系列最適化マルチ特徴量
4チャンネルの音響特徴量を抽出：
- **Channel 0**: Melスペクトログラム（周波数-時間特徴）
- **Channel 1**: MFCC（ケプストラル特徴）
- **Channel 2**: MFCC Delta（時間変化速度）
- **Channel 3**: MFCC Delta-Delta（時間変化加速度）

### 2.2 高解像度処理
- **時系列長**: 1320フレーム（約30.7秒、100%データ利用）
- **周波数解像度**: 128次元
- **最終入力形状**: (128, 1320, 4)
- **hop_length**: 512（高解像度設定）

### 2.3 データ拡張（6倍化）
各音声ファイルに対して6種類の拡張を適用：
1. **オリジナル**: 元データ
2. **ホワイトノイズ**: ノイズ耐性向上
3. **時間シフト**: 位置不変性
4. **時間ストレッチ**: テンポ変化耐性
5. **ピッチシフト**: 音程変化耐性
6. **スペクトラルロールオフ**: 音質変化耐性

---

## 3. 前処理・正規化

### 3.1 適応的チャンネル正規化
各チャンネルの特性に応じた個別正規化：
- **Melスペクトログラム**: 平均0、標準偏差1正規化
- **MFCC**: 第0係数除外正規化
- **Delta系**: 中央値ベース正規化（MAD使用）

### 3.2 高品質リサンプリング
- **Cubic補間**: MFCCを128次元にアップサンプリング
- **Reflect パディング**: 自然な境界処理
- **中央部分抽出**: 情報量最大化

---

## 4. モデルアーキテクチャ詳細

### 4.1 残差ブロック設計
```
時系列重視カーネル: (3, 5) - 周波数3×時間5
ストライド制御: 段階的ダウンサンプリング
ショートカット接続: 勾配消失問題解決
バッチ正規化: 学習安定化
```

### 4.2 Self-Attention機構
```
マルチヘッド数: 8ヘッド → 8ヘッド → 4ヘッド
キー次元: 64 → 64 → 32（段階的縮小）
ドロップアウト: 0.1（過学習防止）
LayerNormalization: 学習安定化
Feed Forward Network: 4倍拡張→元次元
```

### 4.3 テンポラルアテンションプーリング
```
時間次元重み計算: Dense(256) → tanh → Dense(1) → softmax
重み付き平均: Σ(attention_weights × features)
時系列情報の効率的集約
```

---

## 5. 学習設定・最適化

### 5.1 高度なオプティマイザ
```python
Adam(
    learning_rate=0.001,
    beta_1=0.9, beta_2=0.999,
    epsilon=1e-7,
    weight_decay=5e-4  # L2正則化
)
```

### 5.2 時系列特化学習率スケジューラ
- **ウォームアップ期間**: 15エポック（段階的学習率上昇）
- **指数減衰**: エポック15-60（0.96倍減衰）
- **コサイン減衰**: エポック60-120（周期的減衰）

### 5.3 コールバック設定
- **EarlyStopping**: patience=25（時系列モデル用）
- **ReduceLROnPlateau**: factor=0.5, patience=10
- **ModelCheckpoint**: 最良モデル保存

---

## 6. 性能指標・評価

### 6.1 学習メトリクス
- **Accuracy**: 分類精度
- **Top-5 Accuracy**: 上位5位内正解率
- **Loss**: カテゴリカル交差エントロピー

### 6.2 予測分析指標
- **信頼度分布**: 予測確率の最大値
- **エントロピー**: モデルの不確実性
- **決定マージン**: Top1-Top2確率差
- **予測強度**: 確率ベクトルのL2ノルム

### 6.3 詳細評価
- **混同行列**: クラス間の誤分類パターン
- **分類レポート**: Precision, Recall, F1-score
- **信頼度別統計**: 高・中・低信頼度での性能分析

---

## 7. 技術的革新点

### 7.1 時系列最適化
- **100%データ利用**: max_len=1320で情報損失最小化
- **時間軸重視カーネル**: (3,5)で時系列パターン捉獲
- **時系列フォーカス変換**: 2D→1D→Attention流れ

### 7.2 Attention機構活用
- **長距離依存関係**: 音楽の構造的関係性を学習
- **マルチヘッド**: 複数の注意パターン並列学習
- **階層的注意**: 3層での段階的抽象化

### 7.3 ハイブリッド設計
- **ResNet+Transformer**: CNNの局所特徴 + Attentionの大域特徴
- **時系列特化**: 音楽の時間的構造に最適化
- **エンドツーエンド**: 特徴抽出〜分類まで統合学習

---

## 8. 期待される効果

### 8.1 性能向上
- **test_2比**: 情報量10倍、Attention機構追加
- **test_5比**: 時系列最適化、100%データ利用
- **従来手法比**: ResNet+Transformerハイブリッド

### 8.2 汎化性能
- **6種類データ拡張**: 多様な音響条件への対応
- **時系列特化**: テンポ・リズム変化に頑健
- **注意機構**: 楽曲構造の理解

### 8.3 解釈性
- **注意重み**: どの時間部分が重要かを可視化
- **信頼度**: 予測の確実性を定量化
- **エントロピー**: モデルの不確実性を測定

---

## 9. 実装上の考慮点

### 9.1 計算効率
- **バッチサイズ**: 16（メモリ効率とのバランス）
- **GPU活用**: CUDA最適化による高速学習
- **メモリ管理**: 動的GPU メモリ拡張

### 9.2 数値安定性
- **Gradient Clipping**: 勾配爆発防止
- **Dropout**: 複数箇所での過学習防止
- **BatchNormalization**: 内部共変量シフト対策

### 9.3 再現性
- **乱数シード**: 実験再現性確保
- **重み初期化**: Xavier/He初期化
- **学習曲線**: 詳細な学習過程記録

---

## 10. 結論

test_6.ipynbは、音楽の時系列特性を深く理解し、ResNetの局所特徴抽出能力とSelf-Attentionの長距離依存関係捉獲能力を融合した最先端の音楽ジャンル分類モデルです。

**主要成果**:
- 時系列に特化したハイブリッドアーキテクチャの実現
- 100%データ利用による情報損失最小化
- 多層注意機構による楽曲構造理解
- 6種類データ拡張による頑健性向上
- 詳細な予測分析と解釈性提供

このモデルは、従来の音楽分類手法を大幅に上回る性能と解釈性を提供し、音楽情報検索・推薦システムへの応用が期待されます。